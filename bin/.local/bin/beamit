#!/bin/bash
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Config
REGISTRY_DIR="$HOME/.config/beamit"
REGISTRY_FILE="$REGISTRY_DIR/projects"
BASE_PORT=55343

# Determine app name
APP_NAME="${1:-$(basename "$(pwd)")}"
PROJECT_DIR="$(pwd)"

echo -e "${BLUE}Beaming ${APP_NAME}...${NC}"

# Ensure registry directory exists
mkdir -p "$REGISTRY_DIR"
touch "$REGISTRY_FILE"

# Look up existing entry
REGISTRY_LINE=$(grep "^${PROJECT_DIR}	" "$REGISTRY_FILE" 2>/dev/null || true)

if [ -n "$REGISTRY_LINE" ]; then
    SERVER=$(echo "$REGISTRY_LINE" | cut -f3)
    PORT=$(echo "$REGISTRY_LINE" | cut -f4)
    echo -e "${GREEN}Found ${APP_NAME} in registry: ${SERVER}:${PORT}${NC}"
else
    # Ask for server
    echo -e "${YELLOW}New project detected.${NC}"
    read -p "Enter server (e.g. user@host): " SERVER
    if [ -z "$SERVER" ]; then
        echo -e "${RED}Server is required${NC}"
        exit 1
    fi

    # Find max port in registry, default to BASE_PORT-1 if empty
    MAX_PORT=$(cut -f4 "$REGISTRY_FILE" 2>/dev/null | sort -n | tail -1)
    if [ -z "$MAX_PORT" ]; then
        PORT=$BASE_PORT
    else
        PORT=$((MAX_PORT + 1))
    fi

    # Append new entry
    echo -e "${PROJECT_DIR}\t${APP_NAME}\t${SERVER}\t${PORT}" >> "$REGISTRY_FILE"
    echo -e "${GREEN}Registered: ${APP_NAME} on ${SERVER}:${PORT}${NC}"
fi

# Step 1: Build Docker image
echo -e "\n${BLUE}[1/4] Building Docker image...${NC}"
docker build --network=host -t "${APP_NAME}:latest" .

# Step 2: Push image to server
echo -e "\n${BLUE}[2/4] Pushing image to ${SERVER}...${NC}"
docker pussh "${APP_NAME}:latest" "$SERVER"

# Step 3: Handle .env file
echo -e "\n${BLUE}[3/4] Checking .env files...${NC}"

LOCAL_ENV_EXISTS=false
REMOTE_ENV_EXISTS=false
USE_ENV_FILE=false

if [ -f ".env" ]; then
    LOCAL_ENV_EXISTS=true
fi

if ssh "$SERVER" "[ -f ~/${APP_NAME}/.env ]" 2>/dev/null; then
    REMOTE_ENV_EXISTS=true
    USE_ENV_FILE=true
fi

if $LOCAL_ENV_EXISTS && ! $REMOTE_ENV_EXISTS; then
    echo -e "${YELLOW}.env exists locally but not on server.${NC}"
    read -p "Copy .env to server? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        ssh "$SERVER" "mkdir -p ~/${APP_NAME}"
        scp .env "${SERVER}:~/${APP_NAME}/.env"
        echo -e "${GREEN}.env copied to server${NC}"
        USE_ENV_FILE=true
    fi
elif $LOCAL_ENV_EXISTS && $REMOTE_ENV_EXISTS; then
    LOCAL_MD5=$(md5sum .env | cut -d' ' -f1)
    REMOTE_MD5=$(ssh "$SERVER" "md5sum ~/${APP_NAME}/.env" | cut -d' ' -f1)

    if [ "$LOCAL_MD5" != "$REMOTE_MD5" ]; then
        echo -e "${YELLOW}.env files differ (local vs server).${NC}"
        read -p "Overwrite server .env with local? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            scp .env "${SERVER}:~/${APP_NAME}/.env"
            echo -e "${GREEN}.env copied to server${NC}"
        fi
    else
        echo -e "${GREEN}.env files are in sync${NC}"
    fi
    USE_ENV_FILE=true
elif ! $LOCAL_ENV_EXISTS && $REMOTE_ENV_EXISTS; then
    echo -e "${GREEN}Using existing .env on server${NC}"
    USE_ENV_FILE=true
else
    echo -e "${YELLOW}No .env file (local or remote)${NC}"
fi

# Step 4: Restart container
echo -e "\n${BLUE}[4/4] Restarting container on ${SERVER}...${NC}"

ENV_FLAG=""
if $USE_ENV_FILE; then
    ENV_FLAG="--env-file .env"
fi

ssh "$SERVER" "mkdir -p ${APP_NAME} && cd ${APP_NAME} && \
    docker rm -f ${APP_NAME} 2>/dev/null || true && \
    docker run -d \
        --name ${APP_NAME} \
        --restart unless-stopped \
        -p ${PORT}:${PORT} \
        -v \$(pwd)/data:/app/data \
        ${ENV_FLAG} \
        ${APP_NAME}:latest"

# Verification
echo -e "\n${GREEN}Deployment complete!${NC}"
echo -e "${BLUE}Container status:${NC}"
ssh "$SERVER" "docker ps --filter name=${APP_NAME} --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"

echo -e "\n${BLUE}Recent logs:${NC}"
ssh "$SERVER" "docker logs ${APP_NAME} --tail 5 2>&1" || true

echo -e "\n${GREEN}${APP_NAME} is now running on ${SERVER}:${PORT}${NC}"
